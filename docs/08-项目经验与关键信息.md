# 项目经验与关键信息

> 开发过程中积累的关键信息，便于复现与维护。**当前为框架，随开发逐步完善。**

---

## 0. 规划需要获取的信息（清单）

以下为开发前/开发中建议补齐的项，便于自动化与接口对接。

| 类别 | 待获取项 | 状态 |
|------|----------|------|
| 页面元素 | 首页：搜索框、搜索按钮、导航（精选/推荐/关注等）、私信入口、登录入口 | 已录 a11y/URL，见下 |
| 页面元素 | 搜索结果页：关键词入参、视频列表容器、单条视频（标题/作者/链接） | 已录，见 1.2 |
| 页面元素 | 视频详情页：评论区容器、一级评论项、楼中楼、用户昵称/链接 | 已录，见 1.2 |
| 页面元素 | 用户主页、私信弹窗：发私信入口、输入框、发送按钮 | 用户主页「私信」button 已录（§1.4）；对话页输入框/发送待实操补充 |
| 接口 | 通用参数：aid、channel、webid、a_bogus、verifyFp、fp 等 | 已录，见 2.1 |
| 接口 | 搜索接口：关键词传参、分页、响应结构 | 已录，见 2.2 |
| 接口 | 视频/评论接口：aweme 详情、评论列表、分页 | 已录 aweme/detail；评论为独立 comment/list，见 2.2 |
| 接口 | 私信：会话列表、发消息 | 已录 imapi、im/user/info 等，见 2.2 |
| Cookie | 未登录时已有：ttwid、__ac_nonce、__ac_signature、s_v_web_id 等 | 已录 |
| Cookie | 登录后新增：sessionid、sid_guard、uid_tt 等 | 已录，见 3 |
| 风控 | 限流/验证码/滑块出现条件与响应 | 随开发补充 |

---

## 0.1 结合阶段文档的「待集采 / 可能需集采」清单

以下结合 [00-总览](00-总览与索引.md)、[02～05 阶段](02-阶段1-浏览器自动化基础.md) 需求，列出**尚未落实或存在可能需求**的项，便于继续集采。

| 类别 | 待/可能需集采项 | 依据 | 优先级 |
|------|-----------------|------|--------|
| **评论列表接口** | 点击视频页「点击加载更多」或滚动评论区时触发的 XHR：路径、方法、参数（如 cursor、aweme_id）、响应结构（是否含 comment_id、user、content） | M1.4 需解析评论并入库；M2 去重可能用平台 comment_id；当前仅知评论可能在 aweme/detail 内或另有接口 | 高 |
| **楼中楼接口** | 点击「展开N条回复」时触发的请求：子评论接口路径与参数 | M1.5 楼中楼可选；若为独立接口需单独记录 | 高 |
| **私信发送流程** | ① 用户主页上「发私信」入口的 a11y/selector ② 私信对话页：输入框、发送按钮的 a11y/selector ③ 发送一条私信时触发的「发消息」API：URL、Method、Body | M4.2 从名单取用户→打开私信→填入内容→发送；文档已标「待实操补充」 | 高 |
| **用户主页结构** | 用户主页整页关键元素：头像、昵称、简介、关注/粉丝、**发私信** 按钮等 a11y 或 selector | M1.6 可能从主页补全链接；M4 可能从主页进私信 | 中 |
| **搜索分页** | 第二页、第三页请求是否仅为 search/single + offset 递增 + search_id；是否有 cursor 或其它分页参数 | M1.3 滚动加载更多视频；已录 stream/single，再确认分页完整性 | 中 |
| **风控现象** | 限流/验证码/滑块出现时的页面表现、请求失败码或响应体 | M1.7、M4.5 失败与重试；目前为空 | 低（遇则记） |
| **a_bogus / msToken** | 若后续考虑接口直连：生成方式（前端 JS 入口、是否必须） | 非必须，浏览器自动化可带真实 Cookie 与页面生成参数 | 低 |

**建议的下一步集采操作**（需在**已登录**的抖音 PC 页执行，并配合 DevTools Network 抓包）：

1. **评论列表 + 楼中楼**：打开一个视频详情页（如 `https://www.douyin.com/video/7592823686873304330`）→ 打开 DevTools Network，筛选 XHR/Fetch → 点击「点击加载更多」→ 记录新出现的评论相关请求（URL、方法、query/body、响应中 comment 列表结构）；再点击某条评论的「展开N条回复」→ 记录子评论请求。
2. **用户主页 + 发私信入口**：从评论或搜索进入任意用户主页（`https://www.douyin.com/user/<sec_uid>`）→ 取 a11y 或 selector：页面关键块、**「发私信」按钮**。
3. **私信页 + 发送请求**：点击该用户主页的「发私信」或从顶栏私信进入后选择/打开与某用户的会话 → 取私信对话页 a11y：**输入框、发送按钮**；在输入框输入一段测试文案并点击发送 → 在 Network 中抓「发消息」请求（imapi 或 www 域）：URL、Method、Request Body。
4. **风控**：若在以上步骤中遇到验证码、滑块、限流提示，记录页面文案与当时操作。

集采结果按类别补充到本文 §1（元素）、§2（接口）、§4（风控）。

---

## 1. 抖音 PC 网页 — 关键元素与选择器

记录自动化时依赖的 DOM 结构，便于页面改版后快速定位。  
**说明**：下表同时记录「可访问性树 uid」（user-chrome-devtools 的 take_snapshot 所用）与后续可补充的 CSS 选择器；抖音类名多为混淆，建议优先用语义或 data 属性。

### 1.1 首页（未登录 / 已登录）

| 页面/模块 | 用途 | 选择器/ID/Class 或 a11y uid | 备注 |
|-----------|------|-----------------------------|------|
| 搜索框 | 输入关键词 | a11y: `textbox "搜索你感兴趣的内容"` (uid=1_145) | 可点击后 type_text |
| 搜索按钮 | 提交搜索 | a11y: `button "搜索"` (uid=1_149) | 点击后跳转搜索页 |
| 导航-精选 | 链接 | link "精选" url="https://www.douyin.com/jingxuan?from_nav=1" (uid=1_25) |  |
| 导航-推荐 | 链接 | link "推荐" url="https://www.douyin.com/?recommend=1&from_nav=1" (uid=1_34) |  |
| 导航-AI抖音 | 链接 | link "AI抖音" url="https://www.douyin.com/aisearch?from_nav=1" (uid=1_43) |  |
| 导航-关注/朋友/我的 | 链接 | 关注 uid=1_52，朋友 1_61，我的 1_70 | 登录后有效 |
| 私信入口 | 打开私信 | a11y: StaticText "私信" (uid=1_198) | 需登录后补充可点击父节点 |
| 登录入口 | 打开登录层 | a11y: StaticText "登录" (uid=1_213) |  |
| 登录层-扫码/验证码/密码 | 登录方式 | 扫码登录 uid=1_713；验证码登录 1_742；密码登录 1_746 |  |
| 登录层-手机号/验证码输入 | 表单 | textbox "请输入手机号" (uid=1_761)，验证码 (uid=1_767) |  |

**搜索页 URL 格式**（可直接用 URL 打开，便于不依赖搜索框）：  
`https://www.douyin.com/search/<关键词 URL 编码>?from_nav=1`  
示例：`https://www.douyin.com/search/%E6%B5%8B%E8%AF%95`（关键词「测试」）。

**用户主页 URL 格式**（从接口/评论中可见）：  
`https://www.douyin.com/user/<sec_uid>?enter_from=...`  
示例：`https://www.douyin.com/user/MS4wLjABAAAAWn7a4EfkU4vEWP6FnbbnRzFLOaldDPVcZlvBoEefbPNrNGOVyw8pIG47Kunj8qBr`  
（sec_uid 为 Base64 风格字符串。）

### 1.2 搜索结果页（登录后）

- **URL**：`https://www.douyin.com/search/<关键词URL编码>?type=general`（如 `?type=general` 为综合搜索）。
- **Tab**：综合 uid=5_37、视频 5_38、用户 5_39、直播 5_40；多列/单列 5_41/5_42；筛选 5_44。
- **搜索框**：同首页，当前页 a11y 为 textbox value="测试"、button "搜索" (uid=5_25, 5_26)。
- **单条视频卡片**：标题/描述为 StaticText，作者为「@昵称」+ link（用户主页）；时长、点赞数等为相邻 StaticText。列表为多个类似块，无统一 list 容器 uid，需按「标题+作者 link」模式遍历。
- **相关搜索**：StaticText "相关搜索" 下为若干 link（如 uid=5_98～5_105）。

### 1.3 视频详情页与评论区（登录后）

- **URL**：`https://www.douyin.com/video/<aweme_id>`，如 `https://www.douyin.com/video/7592823686873304330`。
- **作者区**：link "作者昵称" 指向用户主页 (uid=6_76/6_78 等)，含粉丝/获赞、button "关注"。
- **评论区**：heading "推荐视频" 上方为评论区；"全部评论" (uid=6_170)、button "点击加载更多" (uid=6_169)；评论输入区附近有 "留下你的精彩评论吧" (uid=6_173)。
- **单条一级评论**：每条含「用户 link（昵称）」「评论正文 StaticText」「时间·地区」「点赞/分享」「回复」；楼中楼为 button "展开N条回复" (如 uid=6_187, 6_198)。用户主页链接格式同 1.1。**「点击加载更多」** 按钮 a11y uid=6_169（以当前视频页 snapshot 为准），用于触发评论分页请求。

### 1.4 用户主页（登录后）

- **URL**：`https://www.douyin.com/user/<sec_uid>`（同 1.1）。
- **关键元素**：头像 image（uid=8_38）、昵称 heading level=1（8_39）、关注/粉丝/获赞（8_40～8_45）、抖音号（8_46～8_47）、简介（8_49）、**私信** button（uid=**8_54**）、分享主页 button（8_53）、关注 button（8_55）。Tab：作品/推荐/喜欢（8_59～8_61）等。

### 1.5 私信（IM）

- **入口**：① 顶栏右上角「私信」（登录后可点击，打开私信叠层）；② 用户主页 button "私信"（uid=8_54）点击后在同一叠层内打开与对应用户的对话。
- **形态**：私信为**弹出的叠层对话窗口**（非独立 URL），不离开当前页。先点顶栏「私信」打开私信页/叠层，再通过**请求**传入目标用户信息即可添加并打开与对应用户的对话（见 §2.2 私信-用户信息）。
- **叠层内结构**（以当前 a11y 为准）：左侧会话列表（昵称、最后一条摘要、时间）；右侧当前对话：对方昵称、提示文案（如「对方回复或关注你之前，只能发送一条文字消息」）、**输入框** textbox description="发送消息" **uid=10_53**（multiline、可填文案）、StaticText "发送消息"(10_52)、关闭会话(10_48)、关注(10_49) 等。发送可通过输入框旁按钮或回车，**发消息请求**需在真实发送一条时抓包确认（imapi 域）。

---

## 2. 抖音接口与请求规范

记录观察到的请求格式、接口路径、参数约定（非官方文档，仅供本项目参考）。

### 2.1 请求基础信息

| 项目 | 说明 |
|------|------|
| 基础域名 | `https://www.douyin.com`；部分请求走 `https://www-hj.douyin.com`（如 aweme stats、query/user、danmaku） |
| 常见请求头 | `user-agent`（Chrome）、`referer: https://www.douyin.com/`、`accept: application/json, text/plain, */*`；Cookie 见下。 |
| 鉴权方式 | 未登录时依赖 Cookie 中的 `ttwid`、`s_v_web_id`（verifyFp/fp 相关）；请求 URL 中常见 `webid`、`uifid`、`a_bogus`、`verifyFp`、`fp` 等参数，疑为前端生成。 |
| 通用 Query 参数（示例） | `device_platform=webapp`、`aid=6383`、`channel=channel_pc_web`、`pc_client_type=1`、`update_version_code=170400`、`version_code=170400`、`version_name=17.4.0`、`cookie_enabled=true`、`screen_width`/`screen_height`、`browser_language=zh-CN`、`browser_platform=Win32`、`browser_name=Chrome`、`webid`、`uifid`、`a_bogus`、`verifyFp`、`fp`。 |

### 2.2 关键接口列表（本次抓到的部分）

| 接口用途 | 方法 | 路径/URL 模式 | 主要参数 | 响应要点 |
|----------|------|---------------|----------|----------|
| 社交/通知数量 | GET | `/aweme/v1/web/social/count` | 见 2.1 通用参数 | JSON，含 notice_count、follow_tab_channel_count 等 |
| 热搜列表 | GET | `/aweme/v1/web/hot/search/list/` | detail_list=1, main_billboard_count=5 等 | 热搜词 |
| 用户设置 | GET | `/aweme/v1/web/get/user/settings` | 通用参数 | 需登录态 |
| 用户风险等级 | GET | `/aweme/v1/web/get/user/risklevel/` | publish_video_strategy_type=2 等 |  |
| 表情列表 | GET | `/aweme/v1/web/emoji/list` | need_all=true |  |
| 登录引导策略 | GET | `/passport/general/login_guiding_strategy/` | passport_jssdk_version、aid、ts 等 | 登录相关 |
| ttwid 校验 | POST | `/ttwid/check/` |  |  |
| 用户查询 | GET | `www-hj.douyin.com` `/aweme/v1/web/query/user/` | 通用参数 |  |
| 视频统计 | POST | `www-hj.douyin.com` `/aweme/v2/web/aweme/stats/` |  |  |
| 弹幕配置 | GET | `www-hj.douyin.com` `/aweme/v1/web/danmaku/conf/get/` | conf_end_type=4 等 |  |
| **关键词搜索（首页）** | GET | `/aweme/v1/web/general/search/stream/` | `keyword`（URL 编码）、`count=10`、`offset=0`、`search_channel=aweme_general`、`search_source=normal_search`、`list_type=single`、通用参数 | 流式/首屏，返回 `data[]` 含 `aweme_info`（作者、视频、sec_uid 等） |
| **关键词搜索（分页）** | GET | `/aweme/v1/web/general/search/single/` | 同上，另加 `offset=10`、`search_id`（来自首请求响应或前端生成） | 分页结果 |
| **视频详情** | GET | `/aweme/v1/web/aweme/detail/` | `aweme_id`、`request_source=600`、`origin_type=video_page` | 单条视频详情，评论由独立 comment/list 加载 |
| **评论列表（一级）** | GET | `www-hj.douyin.com` `/aweme/v1/web/comment/list/` | `aweme_id`、`cursor`（0 为首页，分页用响应中的 cursor）、`count=5`、`item_type=0`、`whale_cut_token`、`cut_version=1`、`rcFT`、通用参数 | 响应：`status_code`、`comments[]`。每条含 `cid`（评论 id）、`text`、`user.uid`/`nickname`/`sec_uid`、`reply_comment_total`、`create_time`、`digg_count` 等。`has_more`、`cursor` 用于分页。 |
| **楼中楼（子评论）** | 待确认 | 可能为同一 comment/list 增加父评论 id 等参数，或另有 reply 接口 | 点击「展开N条回复」时触发的请求待单独抓包确认 |  |
| **私信-会话列表** | POST | `imapi.douyin.com` `/v1/conversation/list` | Body 为 protobuf 或 JSON（需抓包确认） |  |
| **私信-陌生人会话** | POST | `imapi.douyin.com` `/v1/stranger/get_conversation_list` |  |  |
| **私信-未读数** | POST | `imapi.douyin.com` `/v1/client/unread_count` |  |  |
| **私信-用户信息（新增/打开对话）** | POST | `www-hj.douyin.com` `/aweme/v1/web/im/user/info/` | **Body**（application/x-www-form-urlencoded）：`sec_user_ids=["<sec_uid>"]` 或多个，如 `sec_user_ids=%5B%22MS4wLjABAAAA...%22%5D`（URL 编码的 JSON 数组）。传入目标用户 sec_uid 可拉取该用户 IM 信息并用于在前端添加/打开与该用户的私信对话。 | 响应 JSON `data[]` 含 nickname、sec_uid、uid、avatar 等。 |
| **私信-拉取会话消息** | POST | `imapi.douyin.com` `/v1/message/get_user_message` | Content-Type: application/x-protobuf，Body 为 protobuf（含会话/用户标识等） | 用于加载与某用户的聊天记录。 |
| **私信-发消息** | POST | `imapi.douyin.com` `/v1/message/send` | Query：`verifyFp`、`fp`、`msToken`、`a_bogus`（与通用参数一致）。**Body**：Content-Type: application/x-protobuf，为 protobuf 二进制；从抓包可见内含：会话/收件人标识、消息体（含 JSON 片段如 `{"mention_users":[],"aweType":700,"richTextInfos":[],"text":"<消息正文>"}`）、`client_message_id`（UUID）、`stime`（时间戳）等。 | 响应 application/x-protobuf。发文字消息时前端会组 protobuf 并 POST 此接口。 |

**说明**：评论列表已确认为独立接口 `www-hj.douyin.com` `/aweme/v1/web/comment/list/`，见上表。楼中楼（展开回复）可能为同接口加父评论 id 参数，待单独抓包确认。

### 2.3 请求/响应示例

（可粘贴关键请求的 cURL 或 JSON 片段，便于复现。本次仅记录：`/aweme/v1/web/social/count` 返回 JSON 含 `status_code`、`notice_count` 等，响应头含 `cookie_ttwidinfo_webid`。）

```
（更多示例待补充）
```

---

## 3. Cookie 与登录态

记录登录、会话保持、Cookie 获取与使用方式。

| 项目 | 说明 |
|------|------|
| 登录方式 | 扫码登录、验证码登录、密码登录（页面文案：扫码登录 / 验证码登录 / 密码登录）；登录层在首页点击「登录」后出现。 |
| Cookie 存放位置 | 浏览器默认；自动化时可用 Playwright 的 storageState 或 context.cookies() 持久化。 |
| 关键 Cookie 字段（未登录时已出现） | `ttwid`（含设备/会话标识）、`__ac_nonce`、`__ac_signature`、`enter_pc_once=1`、`UIFID_TEMP`、`s_v_web_id`（与 verifyFp 对应）、`x-web-secsdk-uid`、`volume_info`、`device_web_cpu_core`、`device_web_memory_size`、`architecture`、`hevc_supported` 等。 |
| 关键 Cookie 字段（登录后） | **登录态核心**：`sessionid`、`sessionid_ss`、`sid_tt`、`sid_guard`（含过期时间）、`uid_tt`、`uid_tt_ss`。** passport 相关**：`passport_csrf_token`、`passport_csrf_token_default`、`passport_auth_mix_state`、`passport_assist_user`、`passport_mfa_token`。**其它**：`d_ticket`、`n_mh`、`login_time`（时间戳）、`sid_ucp_v1`、`ssid_ucp_v1`、`session_tlb_tag`、`csrf_session_id`、`odin_tt`、`is_staff_user`。与未登录共有字段仍保留（如 `ttwid`、`s_v_web_id`、`UIFID`、`msToken` 等）。 |
| 获取/导出方式 | DevTools → Application → Cookies → 复制；或 Playwright 的 `page.context().cookies()` 导出后写入文件。请求头中的 Cookie 可在 Network 里对任意 www.douyin.com 的请求复制。 |
| 有效期与刷新 | `sid_guard` 带过期时间（如 5184000 秒）；`passport/token/beat/web` 为登录心跳。 |

---

## 4. 风控与限流现象

记录实际遇到的限制、错误码或页面表现，便于调整策略。

| 现象/错误 | 可能原因 | 应对建议 |
|-----------|----------|----------|
| （待补充） |  |  |

---

## 5. 其他经验与坑点

- （待补充：如编码问题、时间戳格式、反爬策略、页面加载等待条件等）

---

**更新说明**：每次在开发中确认到可靠信息时，在此文档对应小节补充，并注明大致日期或版本以便回溯。

**实例验证说明**（2026-02-26，MCP Chrome / user-chrome-devtools）：在新标签打开 `https://www.douyin.com`，按文档 §1.1～§1.5 逐项比对。**结论：与文档一致。** ① **§1.1 首页**：已登录态（有关注/朋友/我的、私信、无「登录」）；搜索框 textbox "搜索你感兴趣的内容"、button "搜索"、导航（精选/推荐/AI抖音）等存在，uid 与文档示例不同属正常（文档已注明以当前页为准）。② **§1.2 搜索页**：URL `search/<关键词>?type=general`、Tab（综合/视频/用户）、搜索框 value 为关键词、视频卡片（标题、@作者、时长、点赞）、相关搜索 均符合。③ **§1.3 视频详情页**：作者区（link 昵称、关注）、heading "推荐视频"、全部评论、button "点击加载更多"、单条评论（用户 link、正文、时间·地区、回复）、button "展开N条回复" 均存在。④ **§1.4 用户主页**：头像、昵称 heading、关注/粉丝/获赞、抖音号、简介、**私信** button、分享主页、关注、作品/推荐/喜欢 Tab 均符合。⑤ **§1.5 私信**：从用户主页点击「私信」打开叠层；叠层内左侧会话列表、右侧当前对话、提示文案「对方回复或关注你之前…」、关闭会话、关注、StaticText "发送消息"、**textbox description="发送消息"**（multiline）均与文档描述一致；输入框 uid 本次为 5_50（文档示例 10_53），以当前 snapshot 为准即可。**未涉及登录**：当前 MCP Chrome 已为登录态，未提示用户登录。

**本次采集说明**（2026-02-26）：  
- **第一次**：未登录下采集首页 a11y、通用参数、未登录 Cookie、部分接口。  
- **第二次（登录后）**：用户扫码/密码登录完成后，在同一浏览器内：① 对「get/user/settings」等请求取 Cookie 头，整理得到**登录态 Cookie**（sessionid、sid_guard、uid_tt、passport_* 等）；② 打开搜索页 `search/测试?type=general`，抓取 **general/search/stream**、**general/search/single** 及搜索页 a11y（Tab、视频卡片、相关搜索）；③ 打开视频详情页 **aweme/detail**，抓取视频详情接口及视频页 a11y（作者、评论区、「全部评论」「点击加载更多」、单条评论与「展开N条回复」）；④ 记录 IM 相关请求（imapi 的 conversation/list、stranger/get_conversation_list、im/user/info）。  
- **本次（2026-02-26 续）**：① 视频页点击「点击加载更多」确认评论为独立接口：`www-hj.douyin.com` `/aweme/v1/web/comment/list/`，参数 `aweme_id`、`cursor`、`count` 等，响应含 `comments[].cid`、`user.sec_uid` 等；② 用户主页 a11y：**发私信** button uid=8_54（当前页），并补充 §1.4 用户主页、§1.5 私信；③ 楼中楼接口、私信对话页输入框/发送按钮、发消息 API 仍待后续在打开私信对话并发送一条时抓包补充。
- **本次（2026-02-26 私信专项）**：① 确认私信为**叠层窗口**；顶栏「私信」打开后叠层内可见会话列表与当前对话；② 叠层内**输入框** a11y uid=10_53（textbox "发送消息"）；③ **新增私信对象**：先打开私信页（点顶栏私信），再 POST `www-hj.douyin.com` `/aweme/v1/web/im/user/info/`，Body `sec_user_ids=["<目标 sec_uid>"]`，即可拉取目标用户 IM 信息并用于在前端添加/打开与该用户的对话；④ 记录 imapi 的 `get_user_message`（拉取会话消息，protobuf）；**发消息 API** 待在实际发送一条时抓包确认。
- **本次（2026-02-26 发消息抓包）**：在私信叠层内对输入框 uid=10_53 输入「集采测试」并回车触发发送，抓包得到**私信-发消息**：POST `imapi.douyin.com` `/v1/message/send`，Query 含 verifyFp、fp、msToken、a_bogus；Body 为 application/x-protobuf，内含会话标识、消息体（JSON 片段含 `text`、`aweType`、`mention_users` 等）、client_message_id、stime。响应 200 为 protobuf；若触达「对方回复或关注你之前只能发一条」限制，页面会显示「发送失败」但请求仍会发出并返回 200。
