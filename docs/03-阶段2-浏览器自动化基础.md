# 阶段 2：浏览器自动化基础（M2）

## 1. 阶段目标与范围

- **目标**：在抖音 PC 网页版（douyin.com）上，通过 Playwright 完成：登录与会话保持、按关键词检索视频、进入视频页拉取一级评论与用户信息，并具备分级风控与 session 校验能力。
- **范围**：仅负责「与网页交互 + 解析数据」，对外暴露符合 M1 API 契约的 Python 接口；不负责持久化与任务编排（由 M3 承接）。
- **前置依赖**：M0 已完成（环境就绪）。可与 M1（GUI 原型）并行开发。
- **接口约束**：实现需符合 M1 定义的 API 契约（`start_collection`、`pause_collection` 等方法的底层能力）。

## 2. 里程碑明细

| 编号 | 里程碑 | 交付物/验收 | 细化说明 |
|------|--------|------------|----------|
| M2.1 | Playwright 接入 | 能启动浏览器、打开 douyin.com；headed/headless 可配置 | 交付：可运行脚本启动浏览器打开抖音首页，无报错；注入常见反检测措施（如 stealth 插件）。 |
| M2.2 | 登录与会话管理 | 扫码/密码登录；Cookie 持久化与复用；session 有效性校验 | 登录成功后通过 `storageState` 持久化；启动时加载已有 Cookie 跳过登录。**新增**：启动任务前调用 `/aweme/v1/web/get/user/settings` 校验 session 是否有效；失效时暂停任务并通知前端。Cookie 文件不纳入 git。 |
| M2.3 | 搜索页解析 | 根据关键词打开搜索页、滚动加载、解析视频列表 | URL 直达：`douyin.com/search/<关键词URL编码>?type=general`。滚动加载更多；解析视频列表：标题、视频链接（aweme_id）、作者昵称、作者 sec_uid、点赞数。可配置单次最多取 N 条视频。 |
| M2.4 | 评论拉取 | 进入视频页、滚动/点击加载评论、解析一级评论 | 从视频列表进入视频页，点击「点击加载更多」或滚动评论区；解析一级评论：评论 ID（cid）、评论内容、评论者昵称、评论者 sec_uid/主页链接、点赞数、时间。可配置每视频评论上限。 |
| M2.5 | 用户信息补全 | 从评论中提取或从主页补全用户信息 | 必选：昵称、主页链接（sec_uid）、评论内容。可选（从用户主页补全）：粉丝数、关注数、简介、是否认证。注意补全请求的频率控制。 |
| M2.6 | 分级风控 | 三级风控响应；session 校验；失败分类与日志 | 见下文 §3.2 分级风控策略。 |

## 3. 技术要点与实现建议

### 3.1 模块接口定义

本模块对外暴露的 Python 接口（供 M3 任务编排调用）：

```python
class BrowserEngine:
    async def launch(self, headless: bool = False) -> None:
        """启动浏览器，加载 Cookie"""

    async def check_session(self) -> bool:
        """校验当前 session 是否有效（请求 user/settings）"""

    async def login(self) -> bool:
        """触发登录流程（打开登录页，等待用户扫码/输入）"""

    async def search_videos(self, keyword: str, max_count: int) -> list[dict]:
        """搜索关键词，返回视频列表"""

    async def fetch_comments(self, video_url: str, max_count: int) -> list[dict]:
        """拉取视频一级评论"""

    async def fetch_user_info(self, sec_uid: str) -> dict:
        """从用户主页补全信息（可选调用）"""

    async def close(self) -> None:
        """关闭浏览器"""
```

### 3.2 分级风控策略

| 级别 | 触发条件 | 响应动作 |
|------|----------|----------|
| **正常** | 无异常 | 按配置间隔执行（翻页 1~3 秒随机延时，页面间 2~5 秒） |
| **预警** | 出现验证码/滑块、连续 2 次元素未找到、响应码异常 | 自动暂停 5~15 分钟（随机）；记录预警日志；通过回调通知前端显示预警状态 |
| **危险** | 30 分钟内触发 3 次预警、session 失效、页面出现"账号异常"文案 | 立即停止任务；标记任务状态为"异常中止"；通知前端需人工介入 |

**风控参数可配置**：

```python
class RiskConfig:
    normal_delay_range: tuple[float, float] = (1.0, 3.0)  # 正常操作间隔
    page_delay_range: tuple[float, float] = (2.0, 5.0)    # 页面切换间隔
    warning_pause_range: tuple[int, int] = (300, 900)      # 预警暂停秒数
    warning_threshold: int = 3       # 触发危险的预警次数
    warning_window: int = 1800       # 预警计数窗口（秒）
    max_retry: int = 2               # 单次操作最大重试
```

### 3.3 元素定位策略

- 抖音网页 class 多为混淆，优先使用 `aria-label`、`role`、`data-*` 属性或文案定位（如 `text="搜索"`）。
- 将所有选择器集中配置为常量模块（`src/backend/browser/selectors.py`），便于页面改版后快速更新。
- 已采集的选择器记录在 [09-项目经验与关键信息.md](09-项目经验与关键信息.md)。

### 3.4 反检测措施

- Playwright headed 模式（默认，反检测能力更强）；headless 作为可选配置。
- 随机延时 + 随机滚动幅度，避免固定间隔的机械化操作。
- User-Agent 保持与真实 Chrome 一致。
- 可选：注入 stealth 脚本（`playwright-stealth`）。

### 3.5 失败分类

所有操作失败需区分类型并记录：

| 失败类型 | 示例 | 处理 |
|----------|------|------|
| **技术失败** | 元素未找到、超时、网络断开 | 重试（最多 max_retry 次），仍失败则记录并跳过 |
| **风控失败** | 验证码、滑块、账号异常提示 | 触发预警/危险响应 |
| **业务失败** | 视频已删除、评论区关闭 | 记录原因，跳过当前项，继续下一个 |

## 4. 验收标准

- [ ] 能通过脚本完成：登录 → 搜索关键词 → 获取至少一页视频列表 → 进入一个视频并拉取至少 10 条一级评论及用户信息。
- [ ] session 校验：有效 Cookie 可跳过登录；Cookie 过期时能正确检测并报告。
- [ ] 分级风控：模拟触发预警条件时自动暂停；模拟触发危险条件时自动停止。
- [ ] 模块接口符合 §3.1 定义，可被 M3 直接调用。

## 5. 产出物清单

- `src/backend/browser/` 模块：engine（主逻辑）、selectors（选择器常量）、risk（风控）。
- Cookie 持久化与加载逻辑。
- 配置：选择器、延时范围、风控参数。
- 文档更新：将实际元素定位策略写入 [09-项目经验](09-项目经验与关键信息.md)。

## 6. 与后续阶段的关系

- M3 将调用本模块的 `search_videos`、`fetch_comments` 等方法串联为采集流水线。
- M5 将调用本模块的 `login`、`check_session` 以及新增的 `send_dm` 方法（M5 阶段扩展本模块）。
- M6 将通过 API 层桥接前端与本模块。
