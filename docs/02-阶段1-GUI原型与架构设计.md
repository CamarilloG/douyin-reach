# 阶段 1：GUI 原型与架构设计（M1）

## 1. 阶段目标与范围

- **目标**：完成桌面 GUI 的技术选型、主框架搭建、全部界面原型（含 mock 数据），并定义前后端 API 契约，驱动后续后端模块的接口设计。
- **范围**：GUI 壳与前端页面、导航结构、mock 数据交互、API 接口契约文档；不包含真实后端逻辑（由 M2～M5 实现，M6 集成）。
- **前置依赖**：M0 已完成（环境与技术栈确认）。
- **可与 M2 并行**：本阶段与浏览器自动化（M2）无直接依赖，可同时推进。

## 2. 里程碑明细

| 编号 | 里程碑 | 交付物/验收 | 细化说明 |
|------|--------|------------|----------|
| M1.1 | 技术骨架搭建 | pywebview + Vue 3 项目可运行；主窗口可打开并显示前端页面 | 后端：`main.py` 启动 pywebview 窗口并加载 Vue 构建产物或开发服务器。前端：Vue 3 + Vite 项目初始化；选择 UI 组件库（如 Naive UI 或 Element Plus）。确认 JS-Python bridge 双向通信可用。 |
| M1.2 | 导航与页面结构 | 侧边栏/顶部导航；6 个主页面的空壳路由 | 页面清单：① 任务管理、② 采集监控、③ 名单审核、④ 发送控制、⑤ 历史记录、⑥ 系统设置。使用 Vue Router 管理路由。 |
| M1.3 | 任务管理页 | 任务列表 + 创建/编辑表单；mock 数据 | 列表：任务名、状态、关键词、创建时间、操作（编辑/删除/启动）。表单：任务名、关键词列表、每视频评论上限、规则白名单/黑名单/正则、私信模板（含变量预览）、发送间隔/日上限/任务上限、全自动/人工确认开关。 |
| M1.4 | 采集监控页 | 当前任务进度、日志流；mock 进度更新 | 展示：当前任务名、状态、当前关键词、已处理视频数/总数、已采集评论数、已采集用户数。日志区：实时滚动的日志条目（时间 + 级别 + 内容）。操作：启动/暂停/停止按钮。 |
| M1.5 | 名单审核页 | 待触达用户列表；勾选/全选/导出 | 表格：昵称、评论内容、来源视频标题、粉丝数（可选）、筛选命中规则、勾选框。操作：全选/反选、导出 CSV、确认发送（仅人工确认模式）。筛选/搜索栏。 |
| M1.6 | 发送控制与历史页 | 发送队列状态、统计数字、历史记录表 | 发送控制：待发数、发送中、已成功、已失败；启动/暂停发送。历史记录：时间、用户昵称、任务名、状态（成功/失败）、失败原因；支持按任务/状态筛选、导出 CSV。 |
| M1.7 | 系统设置页 | 登录状态、全局配置 | 账号：「打开浏览器登录」按钮、当前登录状态指示（已登录/未登录/已过期）。全局默认：发送间隔、日上限、风控阈值。AI 配置：API Key（掩码）、端点、模型名（MVP 仅 UI，不调用）。关于/版本信息。 |
| M1.8 | API 契约定义 | 完整的前后端接口清单文档 | 整理全部 `window.pywebview.api.*` 方法清单（见下文 §3），含方法名、入参、返回值类型、说明。此文档是 M2～M5 实现后端时的约束。 |

## 3. API 契约定义（前后端接口清单）

以下为 pywebview bridge 暴露的 Python 方法，前端通过 `window.pywebview.api.<method>(args)` 调用。

### 3.1 任务管理

| 方法 | 入参 | 返回值 | 说明 |
|------|------|--------|------|
| `get_tasks()` | 无 | `list[Task]` | 获取所有任务列表 |
| `get_task(task_id)` | `int` | `Task` | 获取单个任务详情 |
| `create_task(data)` | `TaskCreate` | `Task` | 创建任务 |
| `update_task(task_id, data)` | `int, TaskUpdate` | `Task` | 更新任务配置 |
| `delete_task(task_id)` | `int` | `bool` | 删除任务 |

### 3.2 采集控制

| 方法 | 入参 | 返回值 | 说明 |
|------|------|--------|------|
| `start_collection(task_id)` | `int` | `bool` | 启动采集 |
| `pause_collection(task_id)` | `int` | `bool` | 暂停采集 |
| `stop_collection(task_id)` | `int` | `bool` | 停止采集 |
| `get_collection_progress(task_id)` | `int` | `Progress` | 获取采集进度快照 |
| `get_logs(task_id, limit)` | `int, int` | `list[LogEntry]` | 获取任务日志 |

### 3.3 筛选与名单

| 方法 | 入参 | 返回值 | 说明 |
|------|------|--------|------|
| `run_filter(task_id)` | `int` | `bool` | 对已采集任务执行规则筛选 |
| `get_target_users(task_id, page, page_size)` | `int, int, int` | `PagedResult[TargetUser]` | 分页获取待触达名单 |
| `update_user_selection(task_id, user_ids, selected)` | `int, list[int], bool` | `bool` | 批量勾选/取消勾选 |
| `export_target_users(task_id, file_path)` | `int, str` | `str` | 导出名单为 CSV，返回文件路径 |

### 3.4 私信发送

| 方法 | 入参 | 返回值 | 说明 |
|------|------|--------|------|
| `start_sending(task_id)` | `int` | `bool` | 启动发送（全自动模式下取全部待发；人工确认模式取已勾选） |
| `pause_sending(task_id)` | `int` | `bool` | 暂停发送 |
| `stop_sending(task_id)` | `int` | `bool` | 停止发送 |
| `get_send_progress(task_id)` | `int` | `SendProgress` | 发送进度（待发/发送中/成功/失败） |
| `get_send_history(task_id, page, page_size, status)` | `int, int, int, str?` | `PagedResult[SendRecord]` | 分页获取发送历史 |
| `export_send_history(task_id, file_path)` | `int, str` | `str` | 导出发送历史为 CSV |

### 3.5 系统与账号

| 方法 | 入参 | 返回值 | 说明 |
|------|------|--------|------|
| `open_login_browser()` | 无 | `bool` | 打开浏览器触发登录流程 |
| `check_login_status()` | `无` | `LoginStatus` | 检查当前登录状态（已登录/未登录/已过期） |
| `get_settings()` | 无 | `Settings` | 获取全局设置 |
| `update_settings(data)` | `SettingsUpdate` | `Settings` | 更新全局设置 |

### 3.6 数据类型定义（简要）

```python
class Task:
    id: int
    name: str
    keywords: list[str]
    status: str            # pending / collecting / collected / filtering / filtered / sending / paused / completed / error
    max_comments_per_video: int
    rules: RuleConfig
    template: str
    send_interval: int     # 秒
    daily_limit: int
    task_limit: int
    auto_send: bool        # True=全自动, False=人工确认
    created_at: str
    updated_at: str

class RuleConfig:
    whitelist: list[str]   # 关键词白名单
    blacklist: list[str]   # 关键词黑名单
    regex_include: list[str]  # 正则-必须命中
    regex_exclude: list[str]  # 正则-排除

class TargetUser:
    id: int
    nickname: str
    profile_url: str
    comment_text: str
    source_video_title: str
    matched_rule: str      # 命中的规则描述
    selected: bool         # 是否已勾选
    send_status: str       # unsent / sending / sent / failed

class Progress:
    task_id: int
    status: str
    current_keyword: str
    current_keyword_index: int
    total_keywords: int
    processed_videos: int
    total_videos: int
    collected_comments: int
    collected_users: int

class SendProgress:
    pending: int
    sending: int
    success: int
    failed: int

class LoginStatus:
    logged_in: bool
    username: str | None
    expires_at: str | None
```

## 4. 技术要点与实现建议

### 4.1 pywebview 配置

- 窗口大小：1280x800（可调整），标题："抖音助手"
- 开发模式：前端用 Vite dev server（热更新），`webview.create_window(url='http://localhost:5173')`
- 生产模式：加载构建后的 `dist/index.html`
- 暴露 `Api` 类实例给前端：`webview.create_window(..., js_api=api_instance)`

### 4.2 前端技术栈

- **Vue 3** + Composition API + TypeScript
- **Vite** 构建
- **UI 组件库**：Naive UI（轻量、Vue 3 原生、暗色主题支持好）或 Element Plus
- **Vue Router**：页面路由
- **Pinia**：状态管理（任务列表、进度、设置等全局状态）

### 4.3 Mock 数据策略

M1 阶段所有 API 返回 mock 数据，便于前端独立开发与演示：

- 创建 `src/backend/api/mock.py`，实现与 `Api` 类相同接口但返回硬编码/随机数据
- 前端开发时切换为 mock 后端
- M6 阶段替换为真实实现

## 5. 验收标准

- [ ] 运行 `python main.py` 可打开桌面窗口，显示 Vue 前端页面，导航可切换 6 个页面。
- [ ] 任务管理页可创建/编辑/删除任务（mock 数据）。
- [ ] 名单审核页可展示列表、勾选、导出 CSV（mock 数据）。
- [ ] API 契约文档完整，覆盖全部前端所需接口，数据类型有明确定义。
- [ ] JS-Python bridge 双向通信可演示（前端调后端方法并接收返回值）。

## 6. 产出物清单

- pywebview 主入口（`main.py`）与 Api 类骨架。
- Vue 3 前端项目（含全部页面组件与路由）。
- Mock 数据后端实现。
- API 契约文档（本文档 §3 或独立文件）。
- 前端 UI 组件库集成与基础主题。

## 7. 与后续阶段的关系

- M2～M5 在实现后端逻辑时，**必须遵循本阶段定义的 API 契约**（方法签名与数据类型）。
- M6 将用真实后端实现替换 mock，无需改动前端代码（接口不变）。
- 若后续发现 API 需调整，应同步更新本文档 §3 并通知前端适配。

## 8. 建议补充（参考 M1 验收，非否决项）

以下为 M1 验收时建议补齐的交互项，在 M1 原型或 M6 集成时实现均可：

- **任务管理页**：实现**编辑弹窗**（与创建表单字段一致），并增加**规则配置**表单项（白名单/黑名单/正则包含/正则排除），与 `RuleConfig` / mock 的 `rules` 结构对接。
- **名单审核页**：在人工确认模式下增加**「确认发送」**按钮，调用 `start_sending(task_id)`；与发送控制页（M1.6）联动说明——两处均可触发发送，名单页侧重「勾选后在此页直接发」，发送控制页侧重「查看全局发送状态与历史」。
