# 阶段 6：GUI 集成与功能完善（M6）

## 1. 阶段目标与范围

- **目标**：将 M1 阶段的 mock 前端与 M2～M5 的真实后端对接，实现全流程可视化操作；补充实时进度推送、数据导出、日志展示等交互能力。
- **范围**：mock 替换为真实 API 实现、实时进度与状态推送、数据导出功能、全流程 GUI 联调。不新增业务逻辑。
- **前置依赖**：M1（GUI 骨架与 mock）、M5（全部后端能力）均已完成。可随 M3/M4/M5 逐步就绪分批接入。

## 2. 里程碑明细

| 编号 | 里程碑 | 交付物/验收 | 细化说明 |
|------|--------|------------|----------|
| M6.1 | API 层实现 | 用真实后端替换 mock Api 类 | 实现 M1 §3 定义的全部 API 方法（`get_tasks`、`start_collection`、`run_filter`、`start_sending` 等），内部调用 M2～M5 模块。统一错误处理：后端异常转为前端可理解的错误消息。 |
| M6.2 | 实时进度推送 | 采集/发送进度实时更新到前端 | 后端通过 `pywebview.evaluate_js()` 向前端推送事件（进度变化、状态变更、日志条目）。前端监听事件并更新 UI。推送频率：进度变化时立即推送，无变化时每 3 秒心跳。 |
| M6.3 | 任务管理集成 | 任务 CRUD 走真实 DB；编辑弹窗与规则表单 | 创建/编辑/删除任务写入 SQLite；任务列表从 DB 读取；任务状态实时反映（状态机生效）。**补充**：实现**编辑弹窗**（与创建表单字段一致），并增加**规则配置**表单项（白名单/黑名单/正则包含/正则排除），与 `task_rules` 表 / `RuleConfig` 结构对接。 |
| M6.4 | 采集流程集成 | GUI 启动采集 → 后端流水线执行 → 进度与日志实时展示 | 点击「开始采集」→ 调用 `start_collection` → 后端启动流水线（独立线程/进程）→ 进度推送到采集监控页 → 日志实时滚动。暂停/停止按钮生效。 |
| M6.5 | 筛选与名单集成 | GUI 触发筛选 → 名单审核页展示真实数据；人工确认下「确认发送」 | 采集完成后可点击「执行筛选」→ 调用 `run_filter` → 名单审核页展示 `target_list` 真实数据。勾选/全选写回 DB。**补充**：在**人工确认模式**下，名单审核页增加**「确认发送」**按钮，调用 `start_sending(task_id)`，与发送控制页联动（两处均可触发发送：名单页侧重勾选后在此页直接发，发送控制页侧重全局状态与历史）。 |
| M6.6 | 发送流程集成 | GUI 启动发送 → 发送进度实时展示 | 全自动模式：点击「开始发送」→ 后端自动遍历发送。人工确认模式：勾选后点击「确认发送」（名单审核页或发送控制页）→ 仅发已选用户。发送进度（待发/成功/失败）实时更新。 |
| M6.7 | 数据导出 | 名单与历史可导出为 CSV | 名单审核页「导出 CSV」→ 弹出保存对话框 → 写入文件。发送历史页同理。CSV 字段：昵称、主页链接、评论内容、来源视频、状态、失败原因等。 |
| M6.8 | 设置与登录集成 | 登录状态、全局设置走真实逻辑 | 「打开浏览器登录」→ 调用 `open_login_browser` → Playwright 打开浏览器。登录状态检测 → 调用 `check_login_status`。设置保存到配置文件。 |

## 3. 技术要点与实现建议

### 3.1 Api 类实现结构

```python
import webview

class Api:
    def __init__(self):
        self.db = Database("data/douyin.db")
        self.browser = BrowserEngine()
        self.filter = FilterEngine(self.db)
        self.sender = DMSender(self.browser, self.db)
        self._window = None  # pywebview 窗口引用

    def set_window(self, window: webview.Window):
        self._window = window

    def _push_event(self, event_type: str, data: dict):
        """向前端推送事件"""
        import json
        js = f"window.dispatchEvent(new CustomEvent('{event_type}', {{detail: {json.dumps(data)}}}));"
        self._window.evaluate_js(js)

    # --- 任务管理 ---
    def get_tasks(self) -> list[dict]: ...
    def create_task(self, data: dict) -> dict: ...
    # ... 其余方法按 M1 §3 契约实现
```

### 3.2 实时推送事件清单

| 事件类型 | 触发时机 | 数据内容 |
|----------|----------|----------|
| `collection:progress` | 采集进度变化 | Progress 快照 |
| `collection:status` | 采集状态变更 | `{task_id, status}` |
| `collection:log` | 新日志条目 | `{level, message, timestamp}` |
| `send:progress` | 发送进度变化 | SendProgress 快照 |
| `send:status` | 发送状态变更 | `{task_id, status}` |
| `send:log` | 发送日志 | `{level, message, timestamp}` |
| `session:changed` | 登录状态变化 | `{logged_in, username}` |
| `risk:warning` | 风控预警 | `{level, message, pause_seconds}` |

### 3.3 前端事件监听示例

```typescript
// Vue composable
function useBackendEvents() {
  const progress = ref<Progress | null>(null)

  onMounted(() => {
    window.addEventListener('collection:progress', (e: CustomEvent) => {
      progress.value = e.detail
    })
    window.addEventListener('risk:warning', (e: CustomEvent) => {
      notification.warning({ content: e.detail.message })
    })
  })

  return { progress }
}
```

### 3.4 线程模型

- **主线程**：pywebview GUI 事件循环。
- **工作线程**：采集流水线、发送流程在独立线程中执行（`threading.Thread`），通过队列与主线程通信。
- **注意**：Playwright 的异步操作需在工作线程中运行独立的事件循环（`asyncio.run`）。
- pywebview API 方法在主线程被调用，若需启动长时任务则提交到工作线程并立即返回。

### 3.5 分步接入策略

M6 可随后端模块逐步就绪分批接入，无需等全部完成：

| 批次 | 接入内容 | 依赖 |
|------|----------|------|
| 第一批 | 任务 CRUD + 设置/登录 | M3.1-M3.2（DB） |
| 第二批 | 采集控制 + 进度 | M3.4-M3.5（流水线） |
| 第三批 | 筛选 + 名单 | M4（规则引擎） |
| 第四批 | 发送 + 历史 | M5（私信发送） |

## 4. 验收标准

- [ ] 通过 GUI 创建任务、配置关键词与规则、保存到 DB，刷新后数据仍在。
- [ ] **任务管理**：支持编辑弹窗（字段与创建一致），且表单含规则配置（白名单/黑名单/正则）；规则写入 DB 并与筛选引擎对接。
- [ ] 启动采集后，采集监控页实时显示进度与日志；暂停/停止生效。
- [ ] 筛选后名单审核页展示真实数据，勾选状态可保存。
- [ ] **名单审核页**：人工确认模式下有「确认发送」按钮，调用 `start_sending(task_id)`；与发送控制页均可触发发送且行为一致。
- [ ] 全自动与人工确认模式均可通过 GUI 触发并完成发送。
- [ ] 名单与历史可导出为 CSV 文件。
- [ ] 登录状态检测与显示正确；设置保存后生效。

## 5. 产出物清单

- `src/backend/api/` 模块：api（Api 类真实实现）、events（事件推送）。
- 前端事件监听与 UI 更新逻辑。
- CSV 导出功能。
- 全流程 GUI 联调通过。

## 6. 与后续阶段的关系

- M7 将基于 M6 的完整 GUI + 后端做端到端联调测试。
- M6 的 API 实现需与 M1 的契约完全一致，任何不一致需同步更新 M1 文档。
