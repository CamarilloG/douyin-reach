# 阶段 4：私信发送与风控（M4）

## 1. 阶段目标与范围

- **目标**：从待触达名单中取用户，在抖音网页版内打开私信入口、填入模板内容并发送；支持模板变量、限速与日/任务上限、全自动或人工确认模式，以及失败重试与记录。
- **范围**：私信模板与变量、浏览器内发送流程、限速与上限、人工确认的名单输入、失败与重试；不包含名单的生成与展示（由 M3、M5 负责）。
- **前置依赖**：M1（浏览器环境）、M2（任务与用户数据）、M3（待触达名单）已完成。

## 2. 里程碑明细

| 编号 | 里程碑 | 交付物/验收 | 细化说明 |
|------|--------|------------|----------|
| M4.1 | 私信模板与变量 | 模板支持变量（如 `{昵称}`、`{评论摘要}`）；配置存储与渲染逻辑 | 模板为字符串，支持占位符如 `{昵称}`、`{评论摘要}` 等；发送前根据当前用户与评论内容替换；模板存任务配置或独立配置表；文档列出全部可用变量。 |
| M4.2 | 发送流程自动化 | 从待触达列表取用户，打开其主页或私信入口，填入内容并发送；记录成功/失败 | 在 M1 同一浏览器上下文中，从名单取一条用户，打开其私信页（或从主页进入私信），填入渲染后的内容并点击发送；将结果写入发送记录表：成功/失败、失败原因、时间。 |
| M4.3 | 限速与上限 | 可配置：发送间隔（秒）、单日上限、单任务上限；超限即停并记录 | 每次发送后等待「发送间隔」秒（可加随机抖动）；当日发送数、本任务发送数分别与上限比较，任一项达上限即停止并记录日志；上限与间隔可从任务或全局配置读取。 |
| M4.4 | 人工确认模式 | 可配置：仅生成名单 / 生成后需在 GUI 勾选确认再发；名单导出与「已选」回写 | 当配置为「人工确认」时，M4 不自动从待触达表取数发送，而是由 M5 提供「待发列表」与用户勾选；M4 接收「已选用户 id 列表」再执行发送。若 M5 未就绪，可先支持「导出待触达名单」与「读取已选列表文件」的简易方式。 |
| M4.5 | 失败与重试 | 发送失败（网络/风控）记录原因；可配置重试次数与退避策略 | 单次发送失败时记录原因（如超时、元素未找到、风控提示）；可配置对该用户重试次数（如 1～2 次）及退避时间；超过重试仍失败则标记为失败并进入下一条，不阻塞整体。 |

## 3. 技术要点与实现建议

- **私信入口**：抖音 PC 网页版私信入口可能为用户主页上的「发私信」或消息中心；需在 M1 基础上补充页面与元素定位，并处理可能的弹窗/验证。
- **风控**：发送间隔与日上限是硬约束，建议默认保守（如间隔 30～60 秒、日上限 20～50），由用户自行调高并承担风险。
- **人工确认**：待触达表可增加「是否已勾选」字段，M5 勾选后写回；M4 仅对「已勾选」且「未发送」的记录执行发送。

## 4. 验收标准

- [ ] 在测试账号下能自动完成：取一名用户 → 打开私信 → 填入带变量的模板 → 发送成功，并写入发送记录。
- [ ] 限速与日/任务上限生效，超限后不再发送并记录。
- [ ] 人工确认模式下，仅当提供「已选用户列表」时才发送；失败有重试与原因记录。

## 5. 产出物清单

- 私信模板解析与变量渲染模块；模板与变量文档。
- 浏览器内私信发送流程（与 M1 共用上下文）；发送记录写入逻辑。
- 限速与上限配置与执行逻辑；人工确认模式下的接口约定（输入：已选用户 id 列表）。
- 失败重试与日志；配置项说明。

## 6. 与后续阶段的关系

- M3 依赖 M4 写入的发送记录做「已发私信」历史校验。M5 将提供名单展示、勾选与「确认发送」按钮，并调用 M4 的发送接口（传入已选列表或全量待触达）。
