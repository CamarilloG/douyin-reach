# 阶段 3：规则与 AI 筛选（M3）

## 1. 阶段目标与范围

- **目标**：在「已采集」的评论与用户数据上，支持关键词/正则规则与可选云端 AI 判断，产出「待触达名单」并写入存储；支持同一用户去重与历史已发私信校验，避免重复触达。
- **范围**：规则配置格式与存储、规则引擎、云端 AI 接口抽象与对接、规则+AI 组合策略、去重与历史校验；不包含发送行为（由 M4 负责）。
- **前置依赖**：M2 已完成（任务、评论、用户已入库，任务状态含「已采集」）。

## 2. 里程碑明细

| 编号 | 里程碑 | 交付物/验收 | 细化说明 |
|------|--------|------------|----------|
| M3.1 | 规则配置格式 | 关键词白名单/黑名单、正则列表；配置文件或 DB 存储；文档说明格式 | 白名单：命中任一即保留；黑名单：命中任一即排除。正则：支持多条，可标定为「必须命中」或「排除」。配置可放在任务维度或全局；若存 DB，需有表或 JSON 字段；文档中给出示例与字段说明。 |
| M3.2 | 规则引擎 | 对单条「评论+用户」执行关键词/正则匹配；输出布尔或标签；批量跑任务下全部新数据 | 输入：单条评论内容（及可选用户昵称/简介）。输出：是否通过规则（布尔）或标签。对某任务下「已采集」且未筛选过的评论逐条执行，结果可写入「待触达」表或标记字段。 |
| M3.3 | 云端 AI 接入 | 抽象「意向判断」接口；对接一家云端 API；输入评论+昵称/简介，输出是否目标用户或简单理由 | 定义统一接口，如 `is_target_user(comment, nickname, intro) -> (bool, reason)`；内部调用国内大模型等云端 API（密钥与端点可配置）；输出便于日志与人工抽检。 |
| M3.4 | 规则+AI 组合 | 支持「仅规则」「仅 AI」「先规则后 AI」等策略；生成待触达名单并写入 DB | 策略示例：仅规则（通过即入名单）；仅 AI（调用 AI 通过即入名单）；先规则后 AI（先规则过滤，再对通过者调 AI）。名单写入「待触达」表或用户表上的状态字段，并关联任务 id。 |
| M3.5 | 去重与历史 | 同一用户多评论只保留一条；已发过私信的用户不再入名单 | 同一平台用户 id 在待触达名单中只保留一条（如取最新评论或第一条）。入名单前查询「发送记录」表，若该用户在本任务或全局已发过私信则跳过；可选：仅本任务去重 或 全局去重，由配置决定。 |

## 3. 技术要点与实现建议

- **规则引擎**：可先用 Python 正则与字符串包含实现；黑名单优先于白名单，或先白名单再黑名单，文档中写清顺序。
- **AI 接口**：建议封装为可插拔实现（如 `AIProvider` 接口），便于后续更换或增加本地模型；请求限流与超时、失败重试需考虑。
- **性能**：AI 按条调用成本与延迟较高，可对「先规则后 AI」策略下通过规则的数据做批量或限流调用；记录调用次数便于成本控制。

## 4. 验收标准

- [ ] 对已采集任务执行筛选后，待触达名单中仅包含通过规则（及若开启则通过 AI）的用户，且同一用户仅一条。
- [ ] 已发过私信的用户不会再次进入待触达名单（按配置的本任务/全局去重）。
- [ ] 规则与 AI 策略可配置；AI 调用失败时有日志且不阻塞规则结果（可选：AI 失败时视为不通过或降级为仅规则）。

## 5. 产出物清单

- 规则配置格式文档与示例；规则引擎模块（关键词/正则执行）。
- 云端 AI 抽象接口与至少一家实现（如国内大模型 API）；配置项：API Key、端点、模型名。
- 规则+AI 组合策略逻辑；去重与历史校验逻辑；待触达名单写入与任务状态更新（如「已筛选」）。

## 6. 与后续阶段的关系

- M4 将读取待触达名单执行发私信，并写入发送记录（供 M3.5 历史校验）。M5 名单审核界面将展示待触达列表及筛选条件，并可勾选后交由 M4 发送。
