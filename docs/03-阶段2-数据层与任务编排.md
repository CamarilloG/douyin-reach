# 阶段 2：数据层与任务编排（M2）

## 1. 阶段目标与范围

- **目标**：设计并实现本地数据模型与存储（SQLite），支持「任务 ↔ 关键词」绑定与任务状态流转，并将 M1 的采集能力串联为可执行的采集流水线（关键词 → 搜索 → 视频 → 评论与用户 → 入库）。
- **范围**：数据表设计、存储接口、任务元数据与状态、流水线编排；不包含规则筛选与私信（由 M3、M4 负责）。
- **前置依赖**：M1 已完成（能产出视频/评论/用户等结构化数据）。

## 2. 里程碑明细

| 编号 | 里程碑 | 交付物/验收 | 细化说明 |
|------|--------|------------|----------|
| M2.1 | 数据模型设计 | 表：任务、视频、评论、用户、规则配置、发送记录；ER 或字段说明写入方案文档 | 任务表：id、名称、关键词列表（或关联关键词表）、状态、创建/更新时间等。视频表：id、任务 id、平台视频 id、标题、链接、作者等。评论表：id、视频 id、用户 id、内容、点赞数等。用户表：id、平台用户 id、昵称、主页链接等。规则配置：可与任务关联或全局。发送记录：用户 id、任务 id、发送时间、成功/失败、失败原因。给出 ER 图或字段列表，写入 `docs/05-数据模型与存储.md` 或主方案第 5 章。 |
| M2.2 | 本地存储实现 | SQLite 建表与迁移；封装写入视频/评论/用户的接口 | 使用 SQLite，建表脚本或迁移工具（如 Alembic 或自研脚本）；提供 Python 接口：写入/更新任务、写入视频、写入评论、写入用户（含去重逻辑，如按平台 id）。 |
| M2.3 | 任务与关键词绑定 | 支持单任务多关键词；任务状态：待执行/采集中/已采集/已筛选/已发送 | 任务可关联多个关键词；执行时按关键词依次检索并汇总视频列表（可去重）。状态枚举明确：待执行 → 采集中（M1 执行中）→ 已采集（M1 完成）→ 已筛选（M3 完成）→ 已发送（M4 完成）。 |
| M2.4 | 采集流水线串联 | 按任务执行：关键词→搜索→视频列表→逐视频评论+用户→入库；支持中断与续跑（可选） | 编排逻辑：取「待执行」或「采集中」任务，遍历其关键词，调用 M1 搜索与解析；对每个视频调用 M1 评论与用户解析，结果写入 DB；任务内可记录「已处理到第几个关键词、第几个视频」，支持中断后从未处理处续跑（可选）。 |

## 3. 技术要点与实现建议

- **DB 选型**：SQLite 足够单机使用；若未来多进程/多机，可再考虑 PostgreSQL 等，当前阶段建议仅 SQLite。
- **去重**：视频按平台视频 id 去重；用户按平台用户 id 去重；评论可按「视频 id + 用户 id + 内容摘要」或平台评论 id 去重，避免重复入库。
- **任务状态**：仅「采集中」时允许流水线占用；其他状态由 M3/M4 或人工触发变更；避免并发执行同一任务。

## 4. 验收标准

- [ ] 执行一次采集流水线后，DB 中能查到对应任务、视频、评论、用户记录，且无重复视频/用户（按设计去重）。
- [ ] 任务状态随流程正确更新；支持多关键词 per 任务。
- [ ] 数据模型文档已更新，表结构可被 M3/M4 直接引用。

## 5. 产出物清单

- 数据模型文档（含表与字段说明或 ER）。
- SQLite 建表/迁移脚本；存储层封装（Python 模块）。
- 采集流水线编排代码（调用 M1 并写库）；任务状态更新逻辑。

## 6. 与后续阶段的关系

- M3 将读取「已采集」任务的评论与用户，执行规则与 AI 筛选，并写入「待触达名单」（可新表或状态字段）。M4 将读取待触达名单并写发送记录。M5 的 GUI 将展示任务列表、进度与名单，依赖本阶段的数据结构。
