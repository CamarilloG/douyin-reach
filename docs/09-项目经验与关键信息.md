# 项目经验与关键信息

> 开发过程中积累的关键信息，便于复现与维护。**随开发逐步完善。**
>
> **注意**：本文档中的阶段引用已更新为新编号（M0～M7），参见 [00-总览与索引](00-总览与索引.md)。

---

## 开发与验收经验（M0 / M1）

> 以下为 M0、M1 通过验收后的开发经验与坑点汇总，便于后续阶段复现与排错。

### 环境与依赖

| 项目 | 经验说明 |
|------|----------|
| **Python 版本** | 文档要求 3.10+；**推荐 3.10～3.12**。在 Python 3.14 + Windows 下，pywebview 依赖的 pythonnet、greenlet 等需本地编译，易因缺少 Microsoft C++ 生成工具而失败。 |
| **后端依赖安装** | 完整 `pip install -r requirements.txt` 在 Windows + Python 3.14 下可能失败。README 已约定：可先执行 `pip install playwright python-dotenv`，桌面壳（pywebview）稍后补装；或使用「仅前端开发模式」在浏览器中开发界面。 |
| **pywebview（Windows）** | 当前 pywebview 6.x 在 Windows 上**强制依赖 pythonnet**（`clr` 模块）。未安装 pythonnet 时无法启动桌面窗口，需安装 [Microsoft C++ 生成工具](https://visualstudio.microsoft.com/visual-cpp-build-tools/) 后重新 `pip install -r requirements.txt`。 |
| **前端路径** | 前端工程位于 **`src/frontend/`**，所有 `npm install`、`npm run dev`、`npm run build` 均在该目录执行；根目录无 package.json，与 00-总览约定一致。 |
| **Playwright** | 安装依赖后需执行 `playwright install chromium`，否则 M2 浏览器自动化无法启动。 |

### 桌面应用运行方式

| 模式 | 命令/条件 | 说明 |
|------|-----------|------|
| **开发模式** | 先 `cd src/frontend && npm run dev`，再在项目根目录 `set DOUYIN_REACH_DEV=1` 后 `python main.py` | 主窗口加载 http://localhost:5173，热更新；需保证前端已启动。 |
| **生产模式** | 先 `cd src/frontend && npm run build`，再在项目根目录 `python main.py` | 主窗口加载本地 `dist/index.html`，不依赖 dev server。 |
| **仅前端（无桌面壳）** | 仅运行 `cd src/frontend && npm run dev`，浏览器打开 http://localhost:5173 | 用于界面开发；此时 `window.pywebview.api` 不可用，接口调用会报错。 |

### 前端技术栈与实现要点

| 项目 | 经验说明 |
|------|----------|
| **UI 与主题** | Naive UI + 暗色主题（darkTheme）+ 中文（zhCN、dateZhCN），在 App.vue 中通过 NConfigProvider 统一配置。 |
| **路由** | 使用 **createWebHashHistory**，便于 pywebview 加载本地 dist 时无需服务器路由支持。 |
| **API 调用** | 前端通过 `src/frontend/src/api/bridge.ts` 封装，仅在存在 `window.pywebview?.api` 时提供 bridge；否则调用会抛错，适合在桌面壳内运行。 |
| **Mock 数据** | M1 阶段后端使用 `MockApi`（`src/backend/api/mock.py`），与 Api 接口一致；M6 替换为真实实现时前端无需改接口。 |

### M2（浏览器自动化）

- **选择器集中配置**：`src/backend/browser/selectors.py`，包含首页/搜索页/视频页/用户页的文案常量与 URL 模板、风控危险文案；页面改版时优先改该文件。
- **Cookie 持久化**：`data/douyin_storage_state.json`（data/ 已 .gitignore），启动时加载、登录后与关闭时保存。
- **Session 校验**：请求 `GET /aweme/v1/web/get/user/settings`，仅当响应含 `user` 或 `user_id` 视为已登录；`status_code=0` 未登录时也会返回，不可单独作为依据。页面有「私信」或「退出登录」时视为已登录并跳过点击。
- **验收脚本**：项目根目录执行 `python scripts/run_m2_acceptance.py`，完成登录→搜索→评论→用户信息流程验证。
- **搜索页视频列表**：搜索页有 Tab「综合 / 视频 / 用户 / 直播」；默认「综合」下可能无视频链接 DOM。需先**点击「视频」Tab**（`get_by_role("tab", name="视频")` 或备用 `get_by_text("视频", exact=True)`）再等待并解析 `a[href*="/video/"]`，否则易得到 0 条视频。
- **MCP 实时监测**：本项目已包含 **项目级 MCP 配置**（[Chrome DevTools MCP](https://github.com/ChromeDevTools/chrome-devtools-mcp)）：`.cursor/mcp.json` 中已将 `chrome-devtools` 配置为 `--browser-url=http://127.0.0.1:9222`，**无需在本地再改 Cursor 的 MCP 设置**。使用方式：① 先运行验收脚本并开启 CDP 端口：`set DOUYIN_REACH_CDP_PORT=9222 && python scripts/run_m2_acceptance.py`（浏览器会占用 9222）；② 在 Cursor 中打开本仓库并**完整重启 Cursor** 以加载 `.cursor/mcp.json`；③ 验收运行期间可用 MCP 的 `list_pages`、`take_snapshot`、`take_screenshot` 等监测该浏览器实例。若未运行验收脚本，9222 无浏览器时 MCP 连接可能失败，属正常。
- **浏览器日志与实例监控（调试验收问题）**：  
  - **完整保存浏览器运行日志**：设置 `DOUYIN_REACH_CDP_PORT=9222` 时，验收脚本会**自动**将页面 `console`、`pageerror`、`requestfailed` 等写入 `logs/acceptance-browser-<时间戳>.log`；也可显式设置 `DOUYIN_REACH_SAVE_BROWSER_LOG=1`。每条一行，格式：`[HH:MM:SS] [类型] 内容`。  
  - **CDP 实例检测**：在**另一个终端**运行 `python scripts/run_cdp_monitor.py`，会每 15 秒轮询 `http://127.0.0.1:9222/json/list` 并将页面列表追加到 `logs/cdp-pages-<时间戳>.log`（一行一条 JSON），便于对照验收流程中页面数量与 URL。需先启动验收（并开启 9222）再运行监控脚本。  
  - **推荐流程**：终端1 执行 `set DOUYIN_REACH_CDP_PORT=9222 && python scripts/run_m2_acceptance.py`；终端2 执行 `python scripts/run_cdp_monitor.py`；验收结束后在终端2 按 Ctrl+C。结合 `logs/acceptance-browser-*.log`、`logs/cdp-pages-*.log` 与 MCP 的 `list_console_messages`/`take_snapshot` 可定位验收中的大量问题。

### 验收结论摘要（M0 / M1）

- **M0**：环境与文档、目录结构、README、.gitignore、requirements.txt、前端 package.json 均符合文档；后端在 Python 3.14 + Windows 下可按 README 使用备用安装方式通过验收。
- **M1**：主窗口 + 6 页导航、任务管理创建/删除/启动、名单审核列表/勾选/导出、API 契约与 bridge 通信均已实现并通过验收。建议后续补充：任务编辑弹窗、规则表单项（白名单/黑名单/正则）、名单审核页「确认发送」按钮（人工确认模式）。

---

## 0. 待采集/补充信息清单

| 类别 | 待获取项 | 状态 | 优先级 |
|------|----------|------|--------|
| 页面元素 | 首页：搜索框、搜索按钮、导航、私信入口、登录入口 | 已录 | — |
| 页面元素 | 搜索结果页：关键词入参、视频列表容器、单条视频 | 已录 | — |
| 页面元素 | 视频详情页：评论区容器、一级评论、楼中楼、用户昵称/链接 | 已录 | — |
| 页面元素 | 用户主页、私信叠层：发私信入口、输入框 | 已录 | — |
| 接口 | 通用参数：aid、channel、webid 等 | 已录 | — |
| 接口 | 搜索接口：关键词传参、分页、响应结构 | 已录 | — |
| 接口 | 评论列表接口：comment/list 参数与响应 | 已录 | — |
| 接口 | 私信：会话列表、发消息（protobuf，仅备参） | 已录 | — |
| Cookie | 未登录/登录后关键字段 | 已录 | — |
| **楼中楼接口** | 点击「展开N条回复」时的子评论接口 | **待确认** | 后续迭代 |
| **风控现象** | 限流/验证码/滑块出现条件与响应 | **待补充** | 遇则记 |

---

## 1. 抖音 PC 网页 — 关键元素与选择器

**说明**：a11y uid 为 user-chrome-devtools take_snapshot 所用，每次快照会变化，以当前页面为准。抖音类名多为混淆，优先用语义属性定位。

### 1.1 首页（未登录 / 已登录）

| 页面/模块 | 用途 | 选择器/a11y 描述 | 备注 |
|-----------|------|------------------|------|
| 搜索框 | 输入关键词 | `textbox "搜索你感兴趣的内容"` | 可点击后 type_text |
| 搜索按钮 | 提交搜索 | `button "搜索"` | 点击后跳转搜索页 |
| 导航-精选 | 链接 | `link "精选"` url=`/jingxuan` | |
| 导航-推荐 | 链接 | `link "推荐"` url=`/?recommend=1` | |
| 导航-AI抖音 | 链接 | `link "AI抖音"` url=`/aisearch` | |
| 导航-关注/朋友/我的 | 链接 | `link "关注"` / `link "朋友"` / `link "我的"` | 登录后有效 |
| 私信入口 | 打开私信 | `StaticText "私信"` | 需登录；点击打开私信叠层 |
| 登录入口 | 打开登录层 | `StaticText "登录"` | 未登录时显示 |
| 登录层 | 登录方式 | 扫码登录 / 验证码登录 / 密码登录 | |
| 手机号/验证码 | 表单 | `textbox "请输入手机号"` / 验证码 textbox | |

**搜索页 URL 格式**：`https://www.douyin.com/search/<关键词 URL 编码>?from_nav=1`

**用户主页 URL 格式**：`https://www.douyin.com/user/<sec_uid>`（sec_uid 为 Base64 风格字符串）

### 1.2 搜索结果页（登录后）

- **URL**：`https://www.douyin.com/search/<关键词URL编码>?type=general`
- **Tab**：综合、视频、用户、直播；多列/单列切换；筛选
- **搜索框**：同首页，当前页 textbox value 为关键词
- **视频卡片**：标题 StaticText、作者「@昵称」+ link（用户主页）、时长、点赞数。列表无统一 list 容器，需按标题+作者模式遍历
- **相关搜索**：StaticText "相关搜索" 下的若干 link

### 1.3 视频详情页与评论区（登录后）

- **URL**：`https://www.douyin.com/video/<aweme_id>`
- **作者区**：`link "作者昵称"` 指向用户主页，含粉丝/获赞、`button "关注"`
- **评论区**：heading "推荐视频" 上方为评论区；"全部评论"、`button "点击加载更多"`
- **单条一级评论**：用户 link（昵称）、评论正文 StaticText、时间地区、点赞/分享、回复；楼中楼为 `button "展开N条回复"`

### 1.4 用户主页（登录后）

- **URL**：`https://www.douyin.com/user/<sec_uid>`
- **关键元素**：头像 image、昵称 heading level=1、关注/粉丝/获赞、抖音号、简介、**`button "私信"`**、分享主页、关注。Tab：作品/推荐/喜欢

### 1.5 私信（IM）

- **入口**：① 顶栏「私信」打开叠层 ② 用户主页 `button "私信"` 打开叠层并定位到对应用户
- **形态**：弹出叠层窗口（非独立 URL），不离开当前页
- **叠层结构**：左侧会话列表（昵称、摘要、时间）；右侧当前对话。提示文案「对方回复或关注你之前，只能发送一条文字消息」
- **输入框**：`textbox description="发送消息"`（multiline）。发送方式：回车或点击发送按钮
- **新增对话**：POST `/aweme/v1/web/im/user/info/`，Body `sec_user_ids=["<sec_uid>"]` 可拉取目标用户 IM 信息并打开对话

---

## 2. 抖音接口与请求规范

### 2.1 请求基础信息

| 项目 | 说明 |
|------|------|
| 基础域名 | `https://www.douyin.com`；部分走 `https://www-hj.douyin.com` |
| 常见请求头 | `user-agent`（Chrome）、`referer: https://www.douyin.com/`、`accept: application/json` |
| 鉴权 | Cookie 中 `ttwid`、`s_v_web_id`；URL 中 `webid`、`a_bogus`、`verifyFp`、`fp` 等前端生成参数 |
| 通用 Query | `device_platform=webapp`、`aid=6383`、`channel=channel_pc_web`、`version_code=170400` 等 |

### 2.2 关键接口列表

| 接口用途 | 方法 | 路径 | 主要参数 | 响应要点 |
|----------|------|------|----------|----------|
| 关键词搜索（首屏） | GET | `/aweme/v1/web/general/search/stream/` | `keyword`、`count=10`、`offset=0`、`search_channel=aweme_general` | 返回 `data[]` 含 `aweme_info` |
| 关键词搜索（分页） | GET | `/aweme/v1/web/general/search/single/` | 同上 + `offset=10`、`search_id` | 分页结果 |
| 视频详情 | GET | `/aweme/v1/web/aweme/detail/` | `aweme_id` | 单条视频详情 |
| **评论列表（一级）** | GET | `www-hj` `/aweme/v1/web/comment/list/` | `aweme_id`、`cursor`、`count=5` | `comments[]` 含 `cid`、`text`、`user.sec_uid`、`has_more`、`cursor` |
| 楼中楼（子评论） | — | 待确认（可能同接口加父评论 ID） | — | 后续迭代时补充 |
| 用户设置（session 校验） | GET | `/aweme/v1/web/get/user/settings` | 通用参数 | 需登录态，可用于校验 session |
| 私信-用户信息 | POST | `www-hj` `/aweme/v1/web/im/user/info/` | Body: `sec_user_ids=["<sec_uid>"]` | 拉取用户 IM 信息 |
| 私信-发消息 | POST | `imapi.douyin.com` `/v1/message/send` | Body: protobuf（含消息体 JSON） | **MVP 不使用此接口**，采用 DOM 自动化发送 |

---

## 3. Cookie 与登录态

| 项目 | 说明 |
|------|------|
| 登录方式 | 扫码、验证码、密码 |
| Cookie 持久化 | Playwright `storageState` 导出/加载 |
| 未登录 Cookie | `ttwid`、`__ac_nonce`、`__ac_signature`、`s_v_web_id`、`UIFID_TEMP` 等 |
| 登录后新增 | `sessionid`、`sessionid_ss`、`sid_tt`、`sid_guard`（含过期时间）、`uid_tt`、`passport_csrf_token` 等 |
| 有效期 | `sid_guard` 约 5184000 秒（~60 天）；`passport/token/beat/web` 为心跳 |

---

## 4. 风控与限流现象

| 现象/错误 | 可能原因 | 应对建议 |
|-----------|----------|----------|
| （随开发遇到时补充） | | |

**记录规范**：遇到风控现象时，记录以下信息：
- 触发时间与当时的操作（如"连续拉取第 N 个视频评论时"）
- 页面表现（文案、弹窗、滑块截图）
- 请求响应（status code、响应体关键字段）
- 恢复方式（等待多久后恢复、是否需要验证）

---

## 5. 其他经验与坑点

| 类别 | 内容 |
|------|------|
| **编码与路径** | 项目路径、文档路径均使用 UTF-8；Windows 下命令行设置环境变量使用 `set DOUYIN_REACH_DEV=1`。 |
| **前端构建** | Vite 构建需在 `src/frontend` 下执行；`vite.config.ts` 使用 `fileURLToPath(new URL('./src', import.meta.url))` 做 alias，避免依赖 `__dirname`（Node 类型需 @types/node）。 |
| **pywebview 与 API** | 暴露给前端的 Api 实例方法返回值须为可 JSON 序列化的类型（dict、list、str、int、bool 等），否则 JS 端无法正确接收。 |
| **任务状态** | M1 Mock 中任务状态含：pending、collecting、collected、filtering、filtered、sending、paused、completed、error；前端展示时需做状态到中文的映射。 |
| **后续可补** | 任务编辑弹窗、规则（白名单/黑名单/正则）表单项、名单审核页「确认发送」入口；楼中楼接口、风控现象遇则记入上文 §4。 |

---

**更新说明**：每次在开发中确认到可靠信息时，在此文档对应小节补充，并注明日期以便回溯。

- **2026-02-26**：补充 §「开发与验收经验（M0/M1）」：环境与依赖、桌面运行方式、前端技术栈要点、M0/M1 验收结论摘要；扩充 §5 其他经验与坑点（编码与路径、前端构建、pywebview 与 API、任务状态、后续可补项）。

---

## 附录：采集日志

> 以下为历次信息采集的操作记录，供回溯参考。

### 2026-02-26 首次采集

- **第一次（未登录）**：采集首页 a11y、通用参数、未登录 Cookie、部分接口。
- **第二次（登录后）**：① 登录态 Cookie（sessionid、sid_guard、uid_tt 等）；② 搜索页 `search/测试?type=general`，抓取 search/stream、search/single 及搜索页 a11y；③ 视频详情页 aweme/detail 及视频页 a11y；④ IM 相关请求（imapi conversation/list、im/user/info）。

### 2026-02-26 续

- 视频页点击「点击加载更多」确认评论为独立接口 `www-hj.douyin.com/aweme/v1/web/comment/list/`，含 aweme_id、cursor、count，响应含 comments[].cid、user.sec_uid。
- 用户主页 a11y：私信 button 确认。
- 楼中楼接口待后续确认。

### 2026-02-26 私信专项

- 确认私信为叠层窗口，非独立 URL。
- 输入框 a11y: textbox "发送消息"（multiline）。
- 新增私信对象：POST im/user/info，传入 sec_uid 可打开对话。
- imapi get_user_message（protobuf）用于拉取聊天记录。

### 2026-02-26 发消息抓包

- 发消息：POST `imapi.douyin.com/v1/message/send`，Body 为 protobuf，内含消息体 JSON（text、aweType 等）、client_message_id、stime。
- 触达"只能发一条"限制时页面显示「发送失败」，但请求仍返回 200。

### 2026-02-26 实例验证

- 按文档 §1.1～§1.5 逐项比对，全部一致。a11y uid 不同属正常（每次快照变化）。
