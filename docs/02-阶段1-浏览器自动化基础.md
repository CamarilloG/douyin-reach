# 阶段 1：浏览器自动化基础（M1）

## 1. 阶段目标与范围

- **目标**：在抖音 PC 网页版（douyin.com）上，通过浏览器自动化完成：登录与会话保持、按关键词检索视频、进入视频页拉取评论与用户信息（含可配置楼中楼与条数上限），并具备基本限流与稳健性能力。
- **范围**：仅负责「与网页交互 + 解析 DOM/数据」，不负责持久化与任务编排（由 M2 承接）。
- **前置依赖**：M0 已完成（环境与目录就绪）。

## 2. 里程碑明细

| 编号 | 里程碑 | 交付物/验收 | 细化说明 |
|------|--------|------------|----------|
| M1.1 | 自动化框架接入 | 选定并集成 Playwright 或 Selenium；能启动浏览器、打开 douyin.com | 推荐 Playwright：异步支持好、反检测能力较强。交付：可运行脚本，启动浏览器并打开 https://www.douyin.com ，无报错；文档中注明所选框架及版本。 |
| M1.2 | 登录与会话保持 | 实现扫码/密码登录流程；Cookie 持久化与复用 | 提供「触发登录」的入口（如脚本或后续 GUI 的按钮）；登录成功后将 Cookie 写入本地文件（如 `config/cookies.json` 或浏览器 profile）；下次启动可加载 Cookie 跳过登录。文档中说明登录方式、Cookie 存放位置及安全注意（不要提交到 git）。 |
| M1.3 | 搜索页解析 | 根据关键词打开搜索页、滚动加载、解析视频列表 | 输入关键词，打开抖音搜索页（如搜索综合/视频），滚动以加载更多；解析列表中的视频：至少包含标题、视频链接、作者 ID/昵称、点赞数等可获取字段；可配置本次任务最多取 N 条视频。 |
| M1.4 | 单视频评论拉取 | 进入单个视频页、滚动评论区、解析一级评论；可配置每视频条数上限 | 从视频列表进入单个视频页，滚动评论区直至达到「每视频条数上限」或无可加载评论；解析每条一级评论：评论内容、评论者昵称、评论者主页链接（或 ID）。 |
| M1.5 | 楼中楼可选 | 可配置开关：是否展开并解析楼中楼 | 在 M1.4 基础上，若配置开启楼中楼：对每条一级评论尝试展开回复，解析回复内容与回复者信息；与一级评论共用「每视频条数」或单独设「每视频一级评论数 + 每条一级评论的楼中楼数」上限，文档中写清逻辑。 |
| M1.6 | 用户信息补全 | 从评论或主页提取：昵称、主页链接（必选）；可选存评论内容与来源视频 ID | 必选字段：昵称、用户主页链接（用于后续发私信）。可选：当前评论内容、来源视频 ID，便于去重与展示。若评论区未暴露主页链接，可进入用户主页再取链接；注意请求频率。 |
| M1.7 | 限流与稳健性 | 随机延时、失败重试、单日/单任务请求量上限；记录失败原因 | 每次翻页/进入新页/展开评论之间增加随机延时（如 1～3 秒）；请求失败（超时、元素未找到）时重试 1～2 次并记录原因；可配置单任务最大请求次数或最大视频数，超限即停；失败原因写入日志便于排查。 |

## 3. 技术要点与实现建议

- **目标页面**：搜索页（关键词 → 视频列表）、视频播放页（评论区）、用户主页（用于补全链接或后续私信入口）。私信页在 M4 实现。
- **元素定位**：抖音网页结构可能随版本变化，建议将选择器集中配置（如常量或配置文件），便于后续维护；优先使用 data 属性或稳定 class，避免纯文案定位。
- **反检测**：使用 Playwright 时可采用 headed/headless 可配置、注入常见反检测脚本（按需）；避免固定间隔与机械化点击，随机延时与随机滚动幅度。
- **与 M2 的边界**：本阶段可先输出「结构化数据」（如 list of dict），由 M2 定义接口后再写入 DB；或 M1 直接按 M2 约定的接口写入（需先定好 M2.1 的字段）。

## 4. 验收标准

- [ ] 在本地能通过脚本完成：登录 → 搜索关键词 → 获取至少一页视频列表 → 进入一个视频并拉取至少 10 条一级评论及用户昵称/链接。
- [ ] 楼中楼与每视频条数可通过配置开关/参数控制。
- [ ] 存在 Cookie 时可不扫码直接进入已登录状态；失败有重试与日志记录。

## 5. 产出物清单

- 自动化脚本或模块：登录、搜索、视频列表解析、评论与用户解析、楼中楼可选逻辑。
- Cookie 持久化与加载逻辑；配置文件或常量：选择器、延时范围、条数上限。
- 文档：浏览器自动化方案（目标页面、元素策略、登录与 Cookie、限流与反检测），可合并到主方案文档第 4 章或单独 `docs/04-浏览器自动化方案.md`。

## 6. 与后续阶段的关系

- M2 将基于 M1 的「数据形状」设计表结构，并调用 M1 的采集能力串联为任务流水线；M4 将在同一浏览器环境中增加「打开私信页并发送」的流程。
